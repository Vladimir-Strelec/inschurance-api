<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>{% block title %}Insurance UI{% endblock %}</title>
  <meta name="description" content="{% block meta_description %}Versicherungen in Nürnberg: Kategorien, Unterkategorien und Anfrageformular. Schnelle Beratung und klare Tarife.{% endblock %}">
  <link rel="canonical" href="https://inschurance.online{{ request.path|default:'/' }}">
  <link rel="alternate" hreflang="de" href="https://inschurance.online{{ request.path|default:'/' }}">
  <link rel="alternate" hreflang="x-default" href="https://inschurance.online{{ request.path|default:'/' }}">
  <meta property="og:url" content="https://inschurance.online{{ request.path|default:'/' }}">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Insurance Portal">
  <meta property="og:title" content="{% block og_title %}Insurance UI{% endblock %}">
  <meta property="og:description" content="{% block og_description %}Versicherungen in Nürnberg: Kategorien, Unterkategorien und Anfrageformular.{% endblock %}">
  <meta property="og:image" content="{% block og_image %}https://placehold.co/1200x630/png{% endblock %}">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{% block tw_title %}Insurance UI{% endblock %}">
  <meta name="twitter:description" content="{% block tw_description %}Versicherungen in Nürnberg: Beratung und Anfrage.{% endblock %}">
  <meta name="twitter:image" content="{% block tw_image %}https://placehold.co/1200x630/png{% endblock %}">

  <link rel="icon" href="data:,">

  <!-- Preconnect -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>

  <!-- Tailwind CSS -->
  <script defer src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Swiper CSS (non-blocking) -->
  <link rel="preload" as="style"
        href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
        onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
  </noscript>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { width: 100%; max-width: 100%; overflow-x: hidden; }
    img, video, svg, canvas { max-width: 100%; height: auto; }
    .overflow-x-clip { overflow-x: clip; }

    /* Анимация появления */
    @keyframes fade-up { 0% {opacity:0; transform: translateY(30px);} 100% {opacity:1; transform: translateY(0);} }
    .animate-fade-up { animation: fade-up .8s ease-out forwards; }

    /* Прячем стрелки и точки только у hero-слайдера */
    .hero-swiper .swiper-button-prev,
    .hero-swiper .swiper-button-next,
    .hero-swiper .swiper-pagination { display: none !important; }
    .hero-swiper { position: relative; }

    /* Плавный скролл + отступ под фикс-хедер */
    html { scroll-behavior: smooth; scroll-padding-top: 5.5rem; }
    section[id], main[id], footer[id], header[id], h1[id], h2[id], h3[id] { scroll-margin-top: 5.5rem; }
  </style>

  <!-- JSON-LD -->
  <script type="application/ld+json">
    {
      "@context":"https://schema.org",
      "@type":"WebSite",
      "name":"Insurance Portal",
      "url":"https://inschurance.online/",
      "potentialAction":{
        "@type":"SearchAction",
        "target":"https://inschurance.online/?q={search_term_string}",
        "query-input":"required name=search_term_string"
      }
    }
  </script>
  <script type="application/ld+json">
    {"@context":"https://schema.org","@type":"Organization","name":"Insurance Portal","url":"https://inschurance.online/","logo":"https://placehold.co/600x315/png"}
  </script>

  <!-- Google Consent Mode v2 (advanced) + GA4 -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }

    /* По умолчанию deny для EEA/UK, чтобы cookieless-хиты были легальными */
    gtag('consent', 'default', {
      'ad_storage': 'denied',
      'analytics_storage': 'denied',
      'ad_user_data': 'denied',
      'ad_personalization': 'denied',
      'wait_for_update': 500,
      'region': ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE',
                 'GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT',
                 'RO','SK','SI','ES','SE','IS','LI','NO','GB']
    });

    /* Рекомендации Гугла для сигналов без кук */
    gtag('set','url_passthrough', true);
    gtag('set','ads_data_redaction', true);
  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z0SDRCBTSR"></script>
  <script>
    gtag('js', new Date());
    gtag('config', 'G-Z0SDRCBTSR', {
      anonymize_ip: true,
      allow_google_signals: false
    });
  </script>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col overflow-x-hidden">
<header id="site-header" class="sticky top-0 z-50 bg-white/90 backdrop-blur transition-transform duration-200">
  <div class="container mx-auto px-4 h-16 flex items-center justify-between">
    <h1 class="text-xl md:text-2xl font-bold">Insurance Portal</h1>

    <!-- Burger (mobile) -->
    <button id="nav-toggle"
            class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-md
                   border border-gray-200 hover:bg-gray-50 focus:outline-none"
            aria-controls="mobile-menu" aria-expanded="false" aria-label="Menü öffnen">
      <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <!-- Desktop nav -->
    <nav aria-label="Hauptnavigation" class="hidden md:flex items-center gap-6">
      <a class="text-sm text-gray-700 hover:text-indigo-600" href="{% url 'category_ui' %}#main">Startseite</a>
      <a class="text-sm text-gray-700 hover:text-indigo-600" href="{% url 'category_ui' %}#about">Über uns</a>
      <a class="text-sm text-gray-700 hover:text-indigo-600" href="{% url 'category_ui' %}#categories">Kategorien</a>
      <a class="text-sm text-gray-700 hover:text-indigo-600" href="{% url 'category_ui' %}#contact">Anfrage hinterlassen</a>
      <a class="text-sm text-gray-700 hover:text-indigo-600" href="#footer">Kontakt</a>
    </nav>
  </div>

  <!-- Mobile dropdown -->
  <div id="mobile-menu" class="md:hidden hidden border-t border-gray-200 bg-white">
    <nav class="px-4 py-3 flex flex-col gap-3" aria-label="Mobile Navigation">
      <a class="py-2 text-gray-800 hover:text-indigo-600" href="{% url 'category_ui' %}#main">Startseite</a>
      <a class="py-2 text-gray-800 hover:text-indigo-600" href="{% url 'category_ui' %}#about">Über uns</a>
      <a class="py-2 text-gray-800 hover:text-indigo-600" href="{% url 'category_ui' %}#categories">Kategorien</a>
      <a class="py-2 text-gray-800 hover:text-indigo-600" href="{% url 'category_ui' %}#contact">Anfrage hinterlassen</a>
      <a class="py-2 text-gray-800 hover:text-indigo-600" href="#footer">Kontakt</a>
    </nav>
  </div>
</header>

<main id="main" class="flex-grow">
  {% block content %}{% endblock %}
</main>

<footer id="footer" class="bg-gray-100 py-4 mt-10 border-t border-gray-200">
  <div class="container mx-auto px-4 text-base text-center text-gray-800">
    &copy; 2025 Insurance Co. Alle Rechte vorbehalten.
  </div>
</footer>

<!-- FAB-кнопка -->
<button id="contact-toggle"
        aria-controls="mini-form-container"
        aria-expanded="false"
        aria-label="Kontaktformular öffnen"
        class="fixed bottom-8 right-0.5 bg-transparent w-36 h-36
               flex items-center justify-center hover:scale-110 transition-transform duration-200
               outline-none focus:outline-none focus:ring-0 focus:ring-offset-0 active:outline-none"
        style="-webkit-tap-highlight-color: transparent;"
        hx-get="{% url 'contact_form_partial' %}?mini=1"
        hx-swap="innerHTML"
        hx-target="#mini-form-container">
  <img alt="Kontakt" class="w-20 h-20 pointer-events-none"
       decoding="async" loading="lazy"
       src="https://www.reshot.com/preview-assets/icons/E2AXH8J35C/to-do-list-E2AXH8J35C.svg"/>
</button>

<!-- Контейнер мини-формы -->
<div id="mini-form-container" role="dialog" aria-modal="true"
     class="hidden fixed bottom-20 right-4 bg-white p-4 rounded-lg shadow-lg border border-gray-200
            max-w-sm w-[calc(100vw-2rem)] sm:w-80"></div>

<!-- HTMX -->
<script defer src="https://unpkg.com/htmx.org@1.9.2"></script>

<!-- Swiper JS -->
<script defer src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- Единый JS-блок -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Мини-форма: открыть/закрыть по клику
    document.addEventListener('click', (e) => {
      const toggle = document.getElementById('contact-toggle');
      const drawer = document.getElementById('mini-form-container');
      if (!toggle || !drawer) return;

      const clickedToggle = toggle.contains(e.target);
      const clickedOutside = !drawer.contains(e.target) && !clickedToggle;

      if (clickedToggle) {
        drawer.classList.toggle('hidden');
        toggle.setAttribute('aria-expanded', drawer.classList.contains('hidden') ? 'false' : 'true');
      } else if (clickedOutside) {
        drawer.classList.add('hidden');
        toggle.setAttribute('aria-expanded', 'false');
      }
    });

    // Swiper init: каждый .swiper отдельно; у hero-swiper без стрелок и точек
    document.querySelectorAll('.swiper').forEach(el => {
      if (typeof Swiper === 'undefined') return;
      const isHero = el.classList.contains('hero-swiper');

      new Swiper(el, {
        slidesPerView: isHero ? 1 : 1.05,
        spaceBetween: isHero ? 0 : 16,
        centeredSlides: isHero,
        loop: true,
        watchOverflow: isHero ? false : true,
        observer: true,
        observeParents: true,
        observeSlideChildren: true,
        autoplay: { delay: 4000, disableOnInteraction: false },
        ...(isHero ? {} : {
          pagination: { el: el.querySelector('.swiper-pagination'), clickable: true },
          navigation: {
            nextEl: el.querySelector('.swiper-button-next'),
            prevEl: el.querySelector('.swiper-button-prev')
          }
        }),
        breakpoints: isHero
          ? { 640:{ slidesPerView: 1 }, 1024:{ slidesPerView: 1 } }
          : {
              640:  { slidesPerView: 1.5, centeredSlides: true, spaceBetween: 20 },
              768:  { slidesPerView: 2,   centeredSlides: true, spaceBetween: 20 },
              1024: { slidesPerView: 3,   centeredSlides: true, spaceBetween: 24 }
            }
      });
    });

    // Анимация появления для .fade-up
    const observer = new IntersectionObserver((entries, ob) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-fade-up');
          ob.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });
    document.querySelectorAll('.fade-up').forEach(el => observer.observe(el));

    // Burger toggle
    const btn = document.getElementById('nav-toggle');
    const menu = document.getElementById('mobile-menu');
    if (btn && menu) {
      btn.addEventListener('click', () => {
        const isHidden = menu.classList.contains('hidden');
        menu.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(isHidden));
        btn.innerHTML = isHidden
          ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                   viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
             </svg>`
          : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                   viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
             </svg>`;
      });

      // Закрывать меню при клике по ссылке
      menu.addEventListener('click', (e) => {
        if (e.target.tagName === 'A') {
          menu.classList.add('hidden');
          btn.setAttribute('aria-expanded', 'false');
          btn.innerHTML =
            `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                  viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
             </svg>`;
        }
      });
    }

    // Скрывать хедер при скролле вниз, показывать при скролле вверх
    const header = document.getElementById('site-header');
    if (header) {
      let lastY = window.scrollY, ticking = false;
      function onScroll() {
        const y = window.scrollY, goingDown = y > lastY, past = y > 32;
        if (goingDown && past) header.classList.add('-translate-y-full');
        else header.classList.remove('-translate-y-full');
        lastY = y; ticking = false;
      }
      window.addEventListener('scroll', () => {
        if (!ticking) { requestAnimationFrame(onScroll); ticking = true; }
      }, { passive: true });
    }

    // Плавный скролл по якорям с учётом высоты шапки (фоллбек)
    (function() {
      const header = document.getElementById('site-header');
      const getHeaderH = () => (header ? header.offsetHeight : 0);
      document.querySelectorAll('a[href*="#"]').forEach(a => {
        const url = new URL(a.href, location.href);
        if (url.pathname !== location.pathname) return;
        const id = url.hash.slice(1); if (!id) return;
        a.addEventListener('click', e => {
          const target = document.getElementById(id); if (!target) return;
          e.preventDefault();
          history.pushState(null, '', '#' + id);
          const y = target.getBoundingClientRect().top + window.pageYOffset - getHeaderH() - 8;
          window.scrollTo({ top: y, behavior: 'smooth' });
        });
      });
    })();
  });
</script>

<!-- === Cookie Banner & Consent === -->
<style>.hyphens-auto{hyphens:auto;-webkit-hyphens:auto;-ms-hyphens:auto}</style>

<div id="cookie-banner"
     class="fixed inset-x-0 bottom-0 z-[60] bg-white border-t border-gray-200 shadow-lg
            md:max-w-4xl md:bottom-6 md:left-1/2 md:-translate-x-1/2 md:rounded-xl md:border md:px-6
            p-4 mx-auto hidden">
  <div class="flex gap-4 items-start">
    <div class="flex-1 text-sm text-gray-800 hyphens-auto">
      <p class="font-semibold mb-1">Cookies & Datenschutz</p>
      <p class="text-gray-600">
        Wir verwenden nur notwendige Cookies. Mit Ihrer Zustimmung aktivieren wir zusätzlich
        <span class="font-medium">Analyse</span> und <span class="font-medium">Marketing</span>.
        Sie können Ihre Auswahl jederzeit ändern.
      </p>
      <button id="open-cookie-prefs" class="mt-2 text-indigo-600 hover:text-indigo-800 text-sm underline">
        Einstellungen
      </button>
    </div>
    <div class="flex gap-2 shrink-0">
      <button id="btn-reject-all" class="px-3 py-2 text-sm rounded-md border border-gray-300 hover:bg-gray-50">
        Nur notwendige
      </button>
      <button id="btn-accept-all" class="px-3 py-2 text-sm rounded-md bg-indigo-600 text-white hover:bg-indigo-700">
        Alle akzeptieren
      </button>
    </div>
  </div>
</div>

<button id="manage-cookies-link"
        class="fixed bottom-4 left-4 z-[50] text-xs text-gray-600 underline bg-white/70 backdrop-blur px-2 py-1 rounded
               hover:text-indigo-700 hidden">
  Cookie-Einstellungen
</button>

<div id="cookie-modal" class="fixed inset-0 z-[70] hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative bg-white w=[min(92vw,560px)] w-[min(92vw,560px)] rounded-xl shadow-xl p-5 mx-auto mt-[10vh]">
    <div class="flex items-start justify-between mb-3">
      <h3 class="text-lg font-semibold">Cookie-Einstellungen</h3>
      <button id="cookie-modal-close" class="p-1 rounded hover:bg-gray-100" aria-label="Schließen">✕</button>
    </div>

    <form id="cookie-form" class="space-y-3">
      <label class="flex items-start gap-3">
        <input type="checkbox" checked disabled class="mt-1">
        <span><span class="font-medium">Notwendig</span>
        <span class="block text-sm text-gray-600">Erforderlich für die Grundfunktionalität.</span></span>
      </label>
      <label class="flex items-start gap-3">
        <input id="consent-analytics" type="checkbox" class="mt-1">
        <span><span class="font-medium">Analyse</span>
        <span class="block text-sm text-gray-600">Anonyme Nutzungsstatistiken (z. B. Analytics).</span></span>
      </label>
      <label class="flex items-start gap-3">
        <input id="consent-marketing" type="checkbox" class="mt-1">
        <span><span class="font-medium">Marketing</span>
        <span class="block text-sm text-gray-600">Personalisierte Inhalte und Kampagnen.</span></span>
      </label>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="cookie-save"
                class="px-3 py-2 text-sm rounded-md bg-indigo-600 text-white hover:bg-indigo-700">
          Speichern
        </button>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
  const BANNER   = document.getElementById('cookie-banner');
  const MODAL    = document.getElementById('cookie-modal');
  const BTN_ACC  = document.getElementById('btn-accept-all');
  const BTN_REJ  = document.getElementById('btn-reject-all');
  const BTN_OPEN = document.getElementById('open-cookie-prefs');
  const BTN_LINK = document.getElementById('manage-cookies-link');
  const BTN_SAVE = document.getElementById('cookie-save');
  const BTN_X    = document.getElementById('cookie-modal-close');

  const CHK_ANAL = document.getElementById('consent-analytics');
  const CHK_MARK = document.getElementById('consent-marketing');

  const COOKIE_NAME = 'cookie_consent_v1';
  const MAX_AGE = 60 * 60 * 24 * 180;

  function parseCookie(name) {
    const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([$?*|{}\]\\\/\+\^])/g,'\\$1') + '=([^;]*)'));
    try { return m ? JSON.parse(decodeURIComponent(m[1])) : null; } catch { return null; }
  }
  function setCookie(name, val, maxAge) {
    const value = encodeURIComponent(JSON.stringify(val));
    const secure = location.protocol === 'https:' ? '; secure' : '';
    document.cookie = `${name}=${value}; path=/; samesite=lax; max-age=${maxAge}${secure}`;
  }

  function getConsent() { return parseCookie(COOKIE_NAME); }
  function saveConsent(consent) { setCookie(COOKIE_NAME, consent, MAX_AGE); applyConsent(consent); }

  function defaultConsent() {
    const dnt = (navigator.doNotTrack === '1' || window.doNotTrack === '1');
    return { necessary: true, analytics: false || !dnt && false, marketing: false || !dnt && false, setAt: Date.now() };
  }

  function show(el){ el && el.classList.remove('hidden'); }
  function hide(el){ el && el.classList.add('hidden'); }

  function openModal() {
    const c = getConsent() || defaultConsent();
    CHK_ANAL.checked = !!c.analytics;
    CHK_MARK.checked = !!c.marketing;
    show(MODAL);
  }
  function closeModal(){ hide(MODAL); }

  // Поднимаем сторонние скрипты по категориям (НЕ для GA)
  function applyConsent(consent) {
    document.querySelectorAll('script[type="text/plain"][data-consent]').forEach(stub => {
      const scope = stub.dataset.consent; if (!scope) return;
      const allowed = !!consent[scope]; const already = stub.dataset.executed === '1';
      if (allowed && !already) {
        const real = document.createElement('script');
        for (const attr of Array.from(stub.attributes)) {
          if (attr.name === 'type' || attr.name === 'data-consent' || attr.name === 'data-src') continue;
          real.setAttribute(attr.name, attr.value);
        }
        if (stub.dataset.src) { real.src = stub.dataset.src; real.async = true; }
        if (stub.textContent.trim()) real.text = stub.textContent;
        real.dataset.executed = '1';
        stub.replaceWith(real);
      }
    });
    show(BTN_LINK);
    hide(BANNER);
  }

  // Преобразуем выбор в команду Consent Mode
  function updateGtagFrom(consent) {
    const analyticsGranted = !!consent.analytics;
    const marketingGranted = !!consent.marketing;
    try {
      gtag('consent','update', {
        'analytics_storage': analyticsGranted ? 'granted' : 'denied',
        'ad_storage':       marketingGranted ? 'granted' : 'denied',
        'ad_user_data':     marketingGranted ? 'granted' : 'denied',
        'ad_personalization': marketingGranted ? 'granted' : 'denied'
      });
      gtag('set','allow_google_signals', marketingGranted);
    } catch(e) {}
  }

  document.addEventListener('DOMContentLoaded', () => {
    let consent = getConsent();

    if (!consent) {
      consent = defaultConsent();
      show(BANNER);
    } else {
      // При наличии сохранённого выбора сразу применяем к сторонним скриптам и Consent Mode
      applyConsent(consent);
      updateGtagFrom(consent);
    }

    BTN_ACC?.addEventListener('click', () => {
      const c = { necessary: true, analytics: true, marketing: true, setAt: Date.now() };
      saveConsent(c);
      updateGtagFrom(c);
    });

    BTN_REJ?.addEventListener('click', () => {
      const c = { necessary: true, analytics: false, marketing: false, setAt: Date.now() };
      saveConsent(c);
      updateGtagFrom(c);
    });

    BTN_OPEN?.addEventListener('click', openModal);
    BTN_LINK?.addEventListener('click', openModal);
    BTN_X?.addEventListener('click', closeModal);

    BTN_SAVE?.addEventListener('click', () => {
      const c = {
        necessary: true,
        analytics: CHK_ANAL.checked,
        marketing: CHK_MARK.checked,
        setAt: Date.now()
      };
      saveConsent(c);
      updateGtagFrom(c);
      closeModal();
    });

    MODAL?.addEventListener('click', (e) => { if (e.target === MODAL) closeModal(); });
  });
})();
</script>
<!-- === /Cookie Banner & Consent === -->

</body>
</html>
